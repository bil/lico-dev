from distutils.core import Extension, setup
import glob

from Cython.Build import cythonize


def setup_drivers(package_name, module_name, driver_names):

    # dynamically add extra source files in driver folder
    driver_files = []
    for name in driver_names:
        files = [f"{package_name}/{name}/{name}.pyx", "utilityFunctions.c"]
        files.extend(glob.glob(f"{package_name}/{name}/*.c"))
        driver_files.append(files)

    driver_extension = [
        Extension(f"{package_name}.{module_name}", [f"{package_name}/{module_name}.pyx"])
    ]

    extensions = driver_extension + [
        Extension(
            f"{package_name}.{name}.{name}", files
        ) for name, files in zip(driver_names, driver_files)
    ]

    setup(
        name=package_name,
        ext_modules=cythonize(extensions, language_level=3),
    )


source_driver_names = [ "{{ "\", \"".join(source_driver_names)}}" ]
setup_drivers("source_drivers", "source_driver", source_driver_names)

sink_driver_names = [ "{{ "\", \"".join(sink_driver_names)}}" ]
setup_drivers("sink_drivers", "sink_driver", sink_driver_names)

